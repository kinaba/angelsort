<!DOCTYPE html>
<html>
<head>
<title>Devils and Angels</title>
<style type="text/css">
#container {
	width: 578px;
	height: 363px;
	background: #efe;
}
</style>
<script src="kinetic-v4.0.1.js"></script>
<script>

function Oracle(n)
{
	var dn = new Array(n);
	var up = new Array(n);
	var commit_sequence = new Array()
	var compare_count = 0;
	for(var v=0; v!=n; ++v) dn[v] = {};
	for(var v=0; v!=n; ++v) up[v] = {};

	this.commit = function(small, big) {
		commit_sequence.push([small, big]);
		up[small][big] = true;
		dn[big][small] = true;
	};

	function closure(next, v) {
		var result = {};
		result[v] = true;
		for(;;) {
			var changed = false;
			for(var u in result)
				for(var t in next[u])
					if(!(t in result)) {
						result[t] = true;
						changed = true;
					}
			if(!changed)
				break;
		}
		return result;
	};

	this.above = function(v) {
		return closure(up, v);
	};

	this.below = function(v) {
		return closure(dn, v);
	};

	this.related = function(v) {
		var result = {};
		var arr = new Array();
		result[v] = true;
		arr.push(v);
		for(;;) {
			var changed = false;
			for(var u in result) {
				for(var t in dn[u])
					if(!(t in result)) {
						result[t] = true;
						arr.push(Number(t));
						changed = true;
					}
				for(var t in up[u])
					if(!(t in result)) {
						result[t] = true;
						arr.push(Number(t));
						changed = true;
					}
			}
			if(!changed)
				break;
		}
		return arr.sort(function(a,b){return a-b;});
	};

	this.compare = function(x, y) {
		++compare_count;
		return this.try_compare(x, y);
	};

	this.try_compare = function(x, y) {
		if(x == y)
			return 0;
		if(x in this.below(y))
			return -1;
		if(y in this.below(x))
			return +1;
		return null;
	};

	this.income_for = function(uu, vv) {
		var cnt = 0;
		for(var u in uu)
		for(var v in vv)
			if(this.try_compare(u,v) == null)
				cnt++;
		return cnt;
	};

	this.total_comparison = function() {
		return compare_count;
	};

	this.getTestArray = function() {
		var a = new Array(n);
		for(var i=0; i!=n; ++i) a[i] = i;
		return a;
	};

	this.getCommitSequence = function() {
		return commit_sequence;
	};

	this.lines = function() {
		var a = new Array();
		for(var v=0; v!=n; ++v)
		for(var u in dn[v])
			a.push([u,v]);
		return a;
	};

	this.dots = function() {
		var level = new Array(n);
		function rec(v) {
			if(level[v] === undefined) {
				level[v] = 0;
				for(var u in dn[v])
					level[v] = Math.max(level[v], rec(u)+1);
			}
			return level[v];
		}
		var maxlevel = 0;
		for(var v=0; v!=n; ++v) maxlevel=Math.max(maxlevel, rec(v));

		var a = new Array();
		var X_UNIT = 0.8/n;
		var Y_UNIT = 0.8/(maxlevel==0 ? 1 : maxlevel);
		var xl = 0.1;
		for(var v=0; v!=n; ++v) if(!a[v]) {
			var uu = this.related(v);
			var levelcnt = new Array(n);
			var lc = 0;
			var maxX = xl;
			for(var k=0; k<uu.length; ++k) {
				var u = uu[k];
				var x = xl + X_UNIT*lc;
				maxX = Math.max(maxX, x);
				a[u] = {x: x, y: 0.9-Y_UNIT*level[u]};
				lc ++;
			}
			xl = maxX + X_UNIT;
		}
		return a;
	};
}

function Angel(n) {
	var self = new Oracle(n);
	var meaningful_compare_count = 0;

	self.meaningful_comparison = function() {
		return meaningful_compare_count;
	};

	self.getComparator = function() { return function(x, y) {
		var t = self.compare(x, y);
		if( t != null )
			return t;
		var xy = self.income_for(self.below(x), self.above(y));
		var yx = self.income_for(self.below(y), self.above(x));
		if( xy < yx )
			self.commit(y, x);
		else
			self.commit(x, y);
		meaningful_compare_count++;
		return self.try_compare(x, y);
	}};
	return self;
}


function Random(n) {
	var self = new Oracle(n);
	var meaningful_compare_count = 0;

	self.meaningful_comparison = function() {
		return meaningful_compare_count;
	};

	self.getComparator = function() { return function(x, y) {
		var t = self.compare(x, y);
		if( t != null )
			return t;
		var xy = self.income_for(self.below(x), self.above(y));
		var yx = self.income_for(self.below(y), self.above(x));
		if( Math.random() < Math.sqrt(xy)/(Math.sqrt(xy)+Math.sqrt(yx)) )
			self.commit(y, x);
		else
			self.commit(x, y);
		meaningful_compare_count++;
		return self.try_compare(x, y);
	}};
	return self;
}


function Devil(n) {
	var self = new Oracle(n);
	var meaningful_compare_count = 0;

	self.meaningful_comparison = function() {
		return meaningful_compare_count;
	};

	self.getComparator = function() { return function(x, y) {
		var t = self.compare(x, y);
		if( t != null )
			return t;
		var xy = self.income_for(self.below(x), self.above(y));
		var yx = self.income_for(self.below(y), self.above(x));
		if( xy < yx )
			self.commit(x, y);
		else
			self.commit(y, x);
		meaningful_compare_count++;
		return self.try_compare(x, y);
	}};
	return self;
}
</script>

<script>
function quickSort(arr, cmp) {
	function impl(s, e) {
		if(e-s <= 1)
			return;
		var p=arr[s], i=s+1, j=e;
		while(i<j) {
			while(i<j && cmp(arr[i],p)<=0) ++i;
			while(i<j && cmp(arr[j-1],p)>0)  --j;
			if(i<j) {var t=arr[i]; arr[i]=arr[j-1]; arr[j-1]=t;}
		}
		if(i==e) {
			{var t=arr[s]; arr[s]=arr[e-1]; arr[e-1]=t;}
			impl(s, e-1);
		} else {
			impl(s, i);
			impl(i, e);
		}
	};
	impl(0, arr.length);
}

function mergeSort(arr, cmp) {
	function impl(s, e) {
		if(e-s<=1)
			return;
		var m = (e+s)>>1;
		impl(s, m);
		impl(m, e);
		var merged = [];
		var i=s, k=m;
		while(i<m && k<e)
			merged.push( cmp(arr[i],arr[k])<0 ? arr[i++] : arr[k++] );
		while(i<m)
			merged.push(arr[i++]);
		while(k<e)
			merged.push(arr[k++]);
		for(var i=s; i<e; ++i)
			arr[i] = merged[i-s];
	}
	impl(0, arr.length);
}

function bubbleSort(arr, cmp) {
	for(var i=0; i<arr.length; ++i)
	for(var k=0; k+1<arr.length-i; ++k)
		if(cmp(arr[k], arr[k+1]) > 0)
			{var t=arr[k]; arr[k]=arr[k+1]; arr[k+1]=t;}
}

function stdSort(arr, cmp) {
	arr.sort(cmp);
}

function heapSort(arr, cmp) {
	for(var i=1; i<arr.length; ++i) {
		var p=i;
		while(p>0) {
			var pp = (p-1)>>1;
			if( cmp(arr[pp], arr[p])<0 ) {
				{var t=arr[pp]; arr[pp]=arr[p]; arr[p]=t;}
				p = pp;
			} else {
				break;
			}
		}
	}
	for(var i=arr.length-1; i>0; --i) {
		{var t=arr[0]; arr[0]=arr[i]; arr[i]=t;}
		var p=0;
		while(p*2+1<i) {
			var pc = (p*2+2>=i || cmp(arr[p*2+1], arr[p*2+2])>0) ? p*2+1 : p*2+2;
			if( cmp(arr[p], arr[pc])<0 ) {
				{var t=arr[pc]; arr[pc]=arr[p]; arr[p]=t;}
				p = pc;
			} else {
				break;
			}
		}
	}
}

function heapSort2(arr, cmp) {
	for(var i=arr.length-1; i>=0; --i) {
		var p=i;
		while(p*2+1<arr.length) {
			var pc = (p*2+2>=arr.length || cmp(arr[p*2+1], arr[p*2+2])>0) ? p*2+1 : p*2+2;
			if( cmp(arr[p], arr[pc])<0 ) {
				{var t=arr[pc]; arr[pc]=arr[p]; arr[p]=t;}
				p = pc;
			} else {
				break;
			}
		}
	}
	for(var i=arr.length-1; i>0; --i) {
		{var t=arr[0]; arr[0]=arr[i]; arr[i]=t;}
		var p=0;
		while(p*2+1<i) {
			var pc = (p*2+2>=i || cmp(arr[p*2+1], arr[p*2+2])>0) ? p*2+1 : p*2+2;
			if( cmp(arr[p], arr[pc])<0 ) {
				{var t=arr[pc]; arr[pc]=arr[p]; arr[p]=t;}
				p = pc;
			} else {
				break;
			}
		}
	}
}
</script>
<script>
var N = 16;
var oracle = null;
var tr = null;
var tr_i = null;
var timer = null;

function step() {
  if(tr_i < tr.length) {
	oracle.commit(tr[tr_i][0], tr[tr_i][1]);
	tr_i ++;
	return true;
  }
  return false;
}

function drawLines(lineLayer, dotLayer) { return function() {
	var canvas = lineLayer.getCanvas();
	canvas.clear();
	var context = canvas.getContext();
	var dots = dotLayer.getChildren();
	var lines = oracle.lines();

	for(var i=0; i<lines.length; ++i) {
		context.beginPath();
		var p = dots[lines[i][0]];
		context.moveTo(p.attrs.x, p.attrs.y);
		var q = dots[lines[i][1]];
		context.lineTo(q.attrs.x, q.attrs.y);
		context.lineWidth = 2;
		context.strokeStyle = "gray";
		context.stroke();
	}
}}

function tango(layer) {
	if(!step()) return;
	var dots = oracle.dots();
	for(var n = 0; n < layer.getChildren().length; n++) {
		var shape = layer.getChildren()[n];
		var stage = shape.getStage();
	 	shape.transitionTo({
			rotation: Math.random() * Math.PI * 2,
			x: dots[n].x * stage.getWidth(),
			y: dots[n].y * stage.getHeight(),
			duration: 1,
			easing: 'ease-in-out'
		});
	}
	timer = setTimeout(function(){tango(layer);}, 1500);
}

var stage = null;
function start() {
	if(!stage) {
		stage = new Kinetic.Stage({
			container: 'container',
			width:  578,
			height: 363
		});
	} else {
		stage.reset();
	}
	var layer = new Kinetic.Layer();

//	var colors = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'cyan', 'magenta'];
	var dots = oracle.dots();
	for(var n=0; n<N; ++n) {
		var shape = new Kinetic.RegularPolygon({
			x: dots[n].x * stage.getWidth(),
			y: dots[n].y * stage.getHeight(),
			sides: 6,
			radius: 10,
			fill: '#'+Math.random().toString(16).slice(-6),
			stroke: 'black',
			strokeWidth: 2
		});
		layer.add(shape);
	}
	var line_layer = new Kinetic.Layer();
	layer.beforeDraw(drawLines(line_layer, layer));
	stage.add(line_layer);
	stage.add(layer);
	timer = setTimeout(timer = function(){tango(layer);}, 1500);
	return false;
};

window.onload = function() {
	var form = document.getElementById("form");
	form.addEventListener('submit', function(e){
		e.preventDefault();
		if(timer)clearTimeout(timer);
		var alg = document.getElementById("algo").value;
		var ora = document.getElementById("oracle").value;
		N = Number(document.getElementById("N").value);
		var trace = window[ora](N);
		window[alg](trace.getTestArray(), trace.getComparator());

		window.oracle = new Oracle(N);
		window.tr = trace.getCommitSequence();
		window.tr_i = 0;
		start();
	});
}
</script>
</head>
<body>
	<form id="form">
		<select id="algo">
			<option value="stdSort">Array.sort</option>
			<option value="bubbleSort">Bubble</option>
			<option value="quickSort">Quick</option>
			<option value="mergeSort">Merge</option>
			<option value="heapSort">Heap</option>
			<option value="heapSort2">Heap:2</option>
		</select>
		<select id="oracle">
			<option value="Angel">Angel</option>
			<option value="Random">Average?</option>
			<option value="Devil">Devil</option>
		</select>
		<select id="N">
			<option value="16">16</option>
			<option value="8">8</option>
		</select>
		<input type="submit" value="start" />
	</form>
	<div id="container"></div>
	<p>by <a href="https://twitter.com/kinaba/status/242985964451016705">@kinaba</a></p>
</body>
</html>
